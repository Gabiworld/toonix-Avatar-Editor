var RegistrationController={ERROR_PAGE:null,serviceURL:null,$registration:null,$avatar:null,$username:null,$usernameErrorImg:null,$usernameErrorTxt:null,$password:null,$passwordErrorImg:null,$passwordErrorImg2:null,$passwordErrorTxt:null,$password2:null,$years:null,$email:null,$email2:null,$fieldsEmailParents:null,$emailParents:null,$emailParents2:null,$residentCountry:null,$registerCountry:null,$terms:null,$termsErrorTxt:null,selectDay:null,selectMonth:null,selectYear:null,selectCountry:null,radioGender:null,$errors:[],$proxyIframe:null,proxyServiceURL:null,needsProxy:false,init:function(){this.serviceURL=$("#registration form").attr("data-service-url");this.needsProxy=!$.support.cors;if(this.needsProxy){this.createProxy()}AvatarDisplayController.init("registration_avatarSwf","252","336",2,true);this.initForm()},onSubmitValidateFields:function(){this.othersValidation();if(this.noErrorsInValidationBrowser()){this.validateUsernameInApi($.proxy(this.submitForm,this))}},noErrorsInValidationBrowser:function(){return this.$errors.length==0},othersValidation:function(){this.validatePassword(this.$password,this.$password2);this.validateFieldAge();this.validateEmail(this.$email,this.$email2);this.validateParentEmail(this.$emailParents,this.$emailParents2,this.$email);this.validateTerms();this.validateUsernameOnlyInBrowser()},validateUsernameFromBrowser:function(){var username=this.$username.val();if(this.validateUsernameOnlyInBrowser()){this.validateUsernameInApi()}},existsErrorsInputUsername:function(){return this.validateUsernameOnlyInBrowser()},validateUsernameOnlyInBrowser:function(){var username=this.$username.val(),without_error=true;this.hideUsernameErrors();if(this.$username.hasClass("placeholder")||username.length<4){this.$usernameErrorMinTxt.show();without_error=false}else{if(username.length>12){this.$usernameErrorMaxTxt.show();without_error=false}else{if(/[^a-z]/ig.test(username)){this.$usernameErrorCharactersTxt.show();without_error=false}}}(!without_error)?this.$errors.push(this.$username):"";return without_error},validateUsernameInApi:function(callback){var username=this.$username.val().toLowerCase();$.ajax({url:CNConfig.validateUsernameServiceURL,data:{username:username,max:10,feed:this.$registerCountry.val()},success:$.proxy(this.showErrorsUsername,this),complete:callback})},showErrorsUsername:function(response){if(response.existsUsername){this.$usernameErrorExistsTxt.show();this.$errors.push(this.$username)}else{if(response.usernameInBlackList){this.$usernameErrorExistsTxt.show();this.$errors.push(this.$username)}else{this.hideUsernameErrors()}}},hideUsernameErrors:function(){this.$usernameErrorExistsTxt.hide();this.$usernameErrorCharactersTxt.hide();this.$usernameErrorMaxTxt.hide();this.$usernameErrorMinTxt.hide()},validateTerms:function(){this.$termsErrorTxt.hide();if(this.$terms.filter(":checked").length==0){this.$termsErrorTxt.show();this.$errors.push(this.$terms)}},validatePassword:function(passwordInput,password2Input){this.hidePasswordErrors();if(!this.isValidPassword(passwordInput)){this.showErrorInNewPassword(false);this.$errors.push(passwordInput)}else{this.validatePasswordEquals(passwordInput.val(),password2Input.val())}},validatePasswordEquals:function(password,password2){if(!this.areEqualsPass(password,password2)){this.showErrorInNewPassword(true);this.$errors.push(this.$password2)}},isCurrentPassInBlank:function(passwordOld){return this.$passwordOld.hasClass("placeholder")||passwordOld.length==0},existsAnyPasswordInputInBlank:function(){return(this.$password.val().length==0||this.$password2.val().length==0)},areEqualsPass:function(password,password2){return password==password2},isValidPassword:function(passwordInput){return(UserUtilController.isValidPassword(passwordInput.val()))},showErrorInNewPassword:function(compareEmail){this.$passwordErrorImg.show();(compareEmail)?(this.showErrorPasswordEquals()):(this.$passwordErrorImg2.hide(),this.$passwordErrorTxt.show())},showErrorPasswordEquals:function(){this.$passwordErrorImg2.show();this.$passwordErrorTxt.hide();this.$passwordError2Txt.show()},hidePasswordErrors:function(){this.$passwordErrorTxt.hide();this.$passwordError2Txt.hide();this.$passwordErrorImg.hide();this.$passwordErrorImg2.hide()},validateEmail:function(emailElement,email2Element){this.hideErrorEmail();var email=emailElement.val(),email2=email2Element.val();if(this.isNotValidEmail(emailElement,email)){this.showEmailError(false);this.$errors.push(emailElement)}else{if(this.notEqualsEmails(email,email2)){this.showEmailError(true);this.$errors.push(email2Element)}}},notEqualsEmails:function(email,email2){return(email!=email2)},isNotValidEmail:function(emailElement,email){return !UserUtilController.isValidEmail(email)||emailElement.hasClass("placeholder")},showEmailError:function(compareEmails){this.$emailErrorImg.show();(compareEmails)?(this.showErrorEmailNotEquals()):(this.$emailErrorTxt.show(),this.$email2ErrorTxt.hide(),this.$emailErrorImg2.hide())},showErrorEmailNotEquals:function(){this.$emailErrorImg2.show();this.$emailErrorTxt.hide();this.$email2ErrorTxt.show()},hideErrorEmail:function(){this.$emailErrorImg.hide();this.$emailErrorImg2.hide();this.$emailErrorTxt.hide();this.$email2ErrorTxt.hide()},validateParentEmail:function(parentEmailInput,parentEmail2Input,emailInput){if(this.isGreaterThan(13,this.$years.val())){var email=emailInput.val(),parentEmail=parentEmailInput.val(),parentEmail2=parentEmail2Input.val();this.hideErrorsParentEmail();if(this.isNotValidEmail(parentEmailInput,parentEmail)){this.showErrorParentEmail();this.$errors.push(parentEmailInput)}else{if(!this.notEqualsEmails(parentEmail,email)){this.showErrorBetweenParentEmailAndEmail();this.$errors.push(parentEmail2Input)}else{if(this.notEqualsEmails(parentEmail,parentEmail2)){this.showErrorParentEmailNotEquals();this.$errors.push(parentEmail2Input)}}}}else{parentEmailInput.val("")}},isGreaterThan:function(num,numToCompare){return num>numToCompare},hideErrorsParentEmail:function(){this.$emailParentsErrorTxt.hide();this.$emailParentsErrorNotEquals1Txt.hide();this.$emailParentsErrorNotEquals2Txt.hide();this.$emailParentsErrorImg.hide();this.$emailParentsErrorImg2.hide()},showErrorBetweenParentEmailAndEmail:function(){this.$emailParentsErrorImg.show();this.$emailParentsErrorNotEquals2Txt.show()},showErrorParentEmailNotEquals:function(){this.$emailParentsErrorImg.show();this.$emailParentsErrorImg2.show();this.$emailParentsErrorNotEquals1Txt.show()},showErrorParentEmail:function(){this.$emailParentsErrorImg.show();this.$emailParentsErrorTxt.show()},onEdadKeyUpHandler:function(){var age=this.$years.val();this.$fieldsEmailParents.css("visibility","visible");this.validateFieldAge();if(!this.isGreaterThan(13,age)){this.$fieldsEmailParents.css("visibility","hidden")}},validateFieldAge:function(){var age=this.$years.val();if(/[^0-9]{1,2}/ig.test(age)){this.$yearsErrorTxt.show();this.$errors.push(this.$years)}else{this.$yearsErrorTxt.hide();this.$yearsErrorImg.hide()}},onIngresarBtnClickHandler:function(){this.submitFormat()},getResidentValue:function(){return this.$registration.find("[name=residentCountry]").val()},getYears:function(){var currentDate=new Date();var cloneAge=null;var userAge=this.$registration.find("[name=age]").val();var currentYear=currentDate.getFullYear();var timeToCompare=new Date(currentYear+"-"+this.getMonthBirthday()+"-"+this.getDayBirthday());var currentTime=new Date(currentYear+"-"+(currentDate.getMonth()+1)+"-"+currentDate.getDate());(currentTime<timeToCompare)?(cloneAge=1):(cloneAge=userAge);return(this.$registration.find("[name=current_year]").val()-cloneAge)},getMonthBirthday:function(){return this.$registration.find("[name=selectMonth]").val()},getDayBirthday:function(){return this.$registration.find("[name=selectDay]").val()},setBirthdate:function(){return this.$registration.find("[name=birthdate]").val(this.getYears()+"-"+this.getMonthBirthday()+"-"+this.getDayBirthday())},getGender:function(){return this.$registration.find("[name=gender]").val()},submitFormat:function(){this.$errors=[];this.onSubmitValidateFields()},submitForm:function(){var ajaxOptions={type:"POST",url:this.serviceURL,success:$.proxy(this.onSaveUserSuccess,this),error:$.proxy(this.onError,this)},data;if(this.$errors.length>0){this.$errors[0].focus();return}data=$.param({username:this.$username.val().toLowerCase(),password:this.$password.val(),gender:this.getGender(),birthdate:this.setBirthdate().val(),residentCountry:this.getResidentValue(),email:this.$email.val(),parentEmail:this.$emailParents.val(),registerCountry:this.$registerCountry.val(),avatar:this.$avatar.replace(/\r?\n/g,"\r\n"),serviceURL:this.serviceURL});if(this.needsProxy){this.proxy(data)}else{ajaxOptions.data=data;$.ajax(ajaxOptions)}},onSaveUserSuccess:function(){CNSessionController.userLogin({username:this.$username.val(),password:this.$password.val()},$.proxy(function(userData){var avatar=$.parseJSON(this.$avatar);CNSessionController.setUserAvatar(avatar,avatar.imageData)},this));trackRegistrations("reg_step_2_user_info");$(".second-part-register").hide();$("#userBar").hide();$(".third-part-register").show();trackRegistrations("reg_success:"+this.getGender().toLowerCase()+":"+this.$years.val()+"_years");CNLAGames.notifyAction("Sys_SignUp");RegistrandoToonixController.animate($.proxy(this.redirectHome,this))},onError:function(jqXHR,textStatus,errorThrown){var code_error=jqXHR.status;this.ERROR_PAGE=$("#registration form").attr("data-error-page")+code_error;$(location).attr("href",this.ERROR_PAGE)},daysInMonth:function(){return new Date(this.getYears()||new Date().getFullYear(),this.selectMonth.$_input.val(),0).getDate()},renderDaysInForm:function(amountDaysMethod){var amountDays=amountDaysMethod(),days=[],it=1;while(it<=amountDays){days.push(it);it++}$(".selectDia_listDias").html("");$.each(days,function(index,value){$(".selectDia_listDias").append('<div class="selectDia_item option" data-value="'+value+'">'+value+"</div>")});$("#registration input[name=selectDay]").remove();new StyledSelect(this.$registration.find(".selectDia"),"selectDay")},assignBehaviorToButton:function(buttonClass,aFunction){$("."+buttonClass).on("click",function(e){e.preventDefault();aFunction})},redirectHome:function(){var url=$("#contenido").attr("data-url-home");$(location).attr("href",url)},initForm:function(){this.initMainForm();this.initUsernameInput();this.initPasswordInput();this.initDateInputs();this.initCountryInput();this.initEmailInput();this.initParentEmailInput();this.initGenderInput();this.initRegistrationCountry();this.initTerms();this.initListenersInput()},initMainForm:function(){this.$registration=$("#registration");this.$registration.find(".cancelar-btn").click($.proxy(this.redirectHome,this));this.$registration.find(".ingresar-btn").click($.proxy(this.onIngresarBtnClickHandler,this))},initRegistrationCountry:function(){this.$registerCountry=this.$registration.find("[name=registrationCountry]")},initGenderInput:function(){this.radioGender=new StyledRadio(this.$registration.find(".contentSex_gender"),"gender")},initUsernameInput:function(){this.$username=this.$registration.find("[name=username]");this.$usernameErrorImg=this.$registration.find(".errorNickImg");this.$usernameErrorTxt=this.$registration.find(".error_nickname");this.$usernameErrorCharactersTxt=this.$registration.find(".error_nickname_characters");this.$usernameErrorMinTxt=this.$registration.find(".error_nickname_min_character");this.$usernameErrorMaxTxt=this.$registration.find(".error_nickname_max_character");this.$usernameErrorExistsTxt=this.$registration.find(".error_nickname_username");this.$username.placeholder()},initTerms:function(){this.$terms=this.$registration.find("[name=terms]");this.$termsErrorTxt=this.$registration.find(".error_terms")},initPasswordInput:function(){this.$password=this.$registration.find("[name=password]");this.$password.placeholder();this.$passwordErrorImg=this.$registration.find(".errorPassImg");this.$passwordErrorImg2=this.$registration.find(".errorPassConfirmImg");this.$passwordErrorTxt=this.$registration.find(".error_user_password");this.$passwordError2Txt=this.$registration.find(".error_user_equals_password");this.$password2=this.$registration.find("[name=password2]");this.$password2.placeholder()},initYearInput:function(){this.$years=this.$registration.find("[name=age]");this.$yearsErrorImg=this.$registration.find(".errorYearImg");this.$yearsErrorTxt=this.$registration.find(".error_year");this.$years.placeholder()},initDateInputs:function(){this.initYearInput();this.selectDay=new StyledSelect(this.$registration.find(".selectDia"),"selectDay");this.selectMonth=new StyledSelect(this.$registration.find(".selectMes"),"selectMonth");this.selectYear=this.$years},initCountryInput:function(){var defaultFeed=CNConfig.feed!=="la"?CNConfig.feed:null;this.selectCountry=new StyledSelect(this.$registration.find(".selectPais"),"residentCountry",{defaultValue:defaultFeed})},initEmailInput:function(){this.$email=this.$registration.find("[name=email]");this.$emailErrorImg=this.$registration.find(".errorMail1Img");this.$emailErrorImg2=this.$registration.find(".errorMail1ConfirmImg");this.$emailErrorTxt=this.$registration.find(".error_mail1");this.$email2ErrorTxt=this.$registration.find(".error_mail2");this.$email2=this.$registration.find("[name=email2]");this.$email.placeholder();this.$email2.placeholder()},initParentEmailInput:function(){this.$fieldsEmailParents=this.$registration.find(".fieldsEmailPadres");this.$emailParents=this.$fieldsEmailParents.find("[name=parentEmail]");this.$emailParentsErrorImg=this.$fieldsEmailParents.find(".errorMail2Img");this.$emailParentsErrorImg2=this.$fieldsEmailParents.find(".errorMail2ConfirmImg");this.$emailParentsErrorTxt=this.$fieldsEmailParents.find(".error_mail_parent1");this.$emailParentsErrorNotEquals1Txt=this.$fieldsEmailParents.find(".error_mail_parent2");this.$emailParentsErrorNotEquals2Txt=this.$fieldsEmailParents.find(".error_mail_parent3");this.$emailParents2=this.$registration.find("[name=emailPadres2]");this.$emailParents.placeholder();this.$emailParents2.placeholder()},initListenersInput:function(){this.$username.blur($.proxy(this.validateUsernameFromBrowser,this));this.$years.keyup($.proxy(this.validateFieldAge,this),$.proxy(this.onEdadKeyUpHandler,this));this.initPasswordListener();this.initEmailListener();this.selectYear.focusout($.proxy(this.renderDaysInForm,this,$.proxy(this.daysInMonth,this)));this.selectMonth.$_input.change($.proxy(this.renderDaysInForm,this,$.proxy(this.daysInMonth,this)))},initPasswordListener:function(){this.$password.blur($.proxy(this.validatePassword,this,this.$password,this.$password2));this.$password2.blur($.proxy(this.validatePassword,this,this.$password,this.$password2))},initEmailListener:function(){this.$email.blur($.proxy(this.validateEmail,this,this.$email,this.$email2));this.$email2.blur($.proxy(this.validateEmail,this,this.$email,this.$email2));this.$emailParents.blur($.proxy(this.validateParentEmail,this,this.$emailParents,this.$emailParents2,this.$email));this.$emailParents2.blur($.proxy(this.validateParentEmail,this,this.$emailParents,this.$emailParents2,this.$email))},createProxy:function(){var regex=/^(http[s]?:\/\/[\w\d\.:]+)\//,iframe_id="proxy-iframe";this.proxyServiceURL=this.serviceURL.match(regex)[1];this.$proxyIframe=$("#"+iframe_id);if(this.$proxyIframe.length===0){this.$proxyIframe=$("<iframe />");this.$proxyIframe.attr({id:"proxy-iframe","class":"invisible",width:0,height:0,src:this.proxyServiceURL+"/proxy"});$("body").append(this.$proxyIframe)}$(window).on("message",$.proxy(this.onCORSMessage,this))},proxy:function(data){this.$proxyIframe[0].contentWindow.postMessage(data,this.proxyServiceURL)},onCORSMessage:function(r){if(r&&typeof r.originalEvent!=="undefined"){if(r.originalEvent.origin!==this.proxyServiceURL){return}r=$.parseJSON(r.originalEvent.data);if(!r.error&&(r.serviceURL===this.serviceURL)){this.onSaveUserSuccess()}else{if(r.error){var response={status:r.error};this.onError(response)}}}}};