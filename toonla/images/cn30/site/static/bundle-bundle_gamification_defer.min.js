(function(w,d,$,CNConfig){var $document=$(d);function _init(){$document.on("session.status",_onSessionStatus)}function _clean(){if(w.gigya){(function(undefined){w.gigya=undefined}())}}function _load(country){var gigyaScript="http://cdn.gigya.com/JS/socialize.js?apiKey=",apiKey={ar:"2_MamcxErMbxpbnvlWdDlHy9mg9FUcKCUl-kMpEOXPRS6R6afPLiMWo66v8Agc5Zo6",br:"2_vODQ3BAuSU8scFply3r1xGbBlzWxqrHbPVId5LUa-jrx-vuf2_IayTIGaCS6LoRb",cl:"2_q3rQbAOK1Ol1debBAILDrezAOT5xsWFbKWX_SQ1ByyVGII3HBe8d_SuBjyFXkWp9",co:"2_1ZNhDOyiEOSXW4M8Lgi4qqSbOzRVeKKBiCd6D2ZUGPJuAghrAI0evvisC_2llTYn",la:"3_9vh1IVp93fmpCWo7igu09umrgyWXMmoXsgsj1s61yZqCamgfPHcbSPIxbR4-OeQ7",mx:"2_9KJsxIA7QcjOjw8SJoX0yBPLcoB0lKFDTdpq8dU67W_7BoVMxQ794QuYVU8UDQNU",ve:"2_tdEbeHdIGBcW7-wg-k3grIo1bZYL_AUU9xxKAg1BdJorEblOJBeiNgD1x8PDQYlQ"},script=$("#gigya");if(script.length===0){script=$("<script />").attr("id","gigya")}else{script.remove()}script.attr("src",gigyaScript+apiKey[country]+"&"+new Date().getTime());$("head").append(script)}function _dispatchEvent(){$document.trigger("gigya.load")}function _setCookie(cookie){if(cookie){$.cookie(cookie.cookieName,cookie.cookieValue,{path:cookie.cookiePath})}}function _onSessionStatus(e,session){_clean();if(session.isUserLoggedIn()){_load(session.getUserRegisterCountryCode())}else{_load(CNConfig.country)}}function _onGigyaServiceReady(serviceName){_dispatchEvent()}w.GigyaController={setCookie:_setCookie};w.onGigyaServiceReady=_onGigyaServiceReady;_init()}(window,document,jQuery,CNConfig));if(this.jQuery){var CNLAGames=(function(){var _version="2.0";var _isLogged=false;var _loggedUserId=0;var _loggedUserCountry=null;var _actionsQueue=[];var _sysActionsQueue=[];var _country="";var _store;var _showGritter=function(data){if($.gritter&&data.levelTitle&&data.levelDescription&&data.badgeURL){$.gritter.add({title:data.levelTitle,text:data.levelDescription,image:data.badgeURL,sticky:false,time:5000})}};var _getUserAchievements=function(challenges,fullInfo,callback){if(_loggedUserId>0){gigya.gm.getChallengeStatus({includeChallenges:challenges,details:"full",callback:callback})}else{callback(null)}};var _parseQueue=function(){var lenActions=_actionsQueue.length,lenSysActions=_sysActionsQueue.length,i;if(lenActions===0&&lenSysActions===0){trace("## CNLA Gamification - No actions queue to parse")}else{trace("## CNLA Gamification - Parsing queue");for(i=0;i<lenActions;i++){_instance.notifyAction(_actionsQueue[i])}for(i=0;i<lenSysActions;i++){_instance.notifyAction(_sysActionsQueue[i])}_actionsQueue=[];_sysActionsQueue=[];if(_store){_store.set("sysActionsQueue",_sysActionsQueue,5)}}};var _checkIfAlreadyNotified=function(actionId){var actionsLogged=$.cookie("CNLAGamesBadges");if(actionsLogged){var actionsList=actionsLogged.split(",");for(var i=0,len=actionsList.length;i<len;i++){var actionName=actionsList[i].split("|")[0];var actionUser=actionsList[i].split("|")[1];if((actionName==actionId)&&(actionUser==_loggedUserId)){trace("## CNLA Gamification - Action "+actionId+" already notified");return true}}}return false};var _saveToCookie=function(actionId){var actionsLogged=$.cookie("CNLAGamesBadges");if(!actionsLogged){actionsLogged=""}actionsLogged=actionsLogged+","+actionId+"|"+_loggedUserId;$.cookie("CNLAGamesBadges",actionsLogged,{path:"/",expires:365})};var _getSavedSysLevel=function(sysId){var allLevels=$.cookie("CNLAGamesLevels");var list=(typeof(allLevels)!="undefined"&&allLevels!==null)?allLevels.split("|"):[];var ret=0;for(var i=0,len=list.length;i<len;i++){var challengeName=list[i].split(":")[0];var challengeLevel=parseInt(list[i].split(":")[1],10);if(challengeName.toLowerCase()===sysId.toLowerCase()){ret=challengeLevel;break}}return ret};var _saveNewSysLevel=function(sysId,oldLevel,newLevel){var allLevels=$.cookie("CNLAGamesLevels")||"";if(allLevels.indexOf(sysId)!=-1){allLevels=allLevels.replace(sysId+":"+oldLevel,sysId+":"+newLevel)}else{allLevels=allLevels+"|"+sysId+":"+newLevel}$.cookie("CNLAGamesLevels",allLevels,{path:"/",expires:365})};var _onNotifyActionSuccess=function(data,actionId){trace("## CNLA Gamification - Action notified. Error code #"+data.errorCode);var actionPrefix=actionId.substr(0,actionId.indexOf("_"));if(data.errorCode===0){if(actionPrefix.toLowerCase()!=="sys"){_saveToCookie(actionId);_getUserAchievements(actionId,true,_onGetDataShowBadge)}else{_getUserAchievements(actionId,true,_onGetDataCheckForNewLevel)}if(typeof(CNApplicationContainer)!="undefined"){CNApplicationContainer.updateMedallero()}}};var _onGetDataShowBadge=function(data){if((typeof(data)!="undefined")&&(parseInt(data.errorCode,10)===0)&&(typeof(data.achievements)!="undefined")&&(data.achievements.length===1)){_showGritter(data.achievements[0])}else{trace("## CNLA Gamification - Data invalid")}};var _onGetDataCheckForNewLevel=function(data){if((typeof(data)!="undefined")&&(parseInt(data.errorCode,10)===0)&&(typeof(data.achievements)!="undefined")&&(data.achievements.length===1)){var sysId=data.achievements[0].challengeID;var savedLevel=_getSavedSysLevel(sysId);var currentLevel=parseInt(data.achievements[0].level,10);if(currentLevel>savedLevel){_showGritter(data.achievements[0]);_saveNewSysLevel(sysId,savedLevel,currentLevel)}}else{trace("## CNLA Gamification - Data invalid")}};var _instance={setPoints:function(points){trace("## CNLA Gamification - setPoints not yet implemented")},notifyLogin:function(session){trace("## CNLA Gamification - Login detected");_loggedUserId=session.getUserId();_loggedUserCountry=session.getUserRegisterCountryCode();trace("## CNLA Gamification - User logged id #"+_loggedUserId);_parseQueue()},notifyLogout:function(){trace("## CNLA Gamification - Logout detected");_isLogged=false},notifyAction:function(actionId){var alreadyNotified;if(_isLogged){trace("## CNLA Gamification - User id #"+_loggedUserId+" - Notifying action: "+actionId);switch(actionId.toLowerCase()){case"playgame":trace("## CNLA Gamification - Play game");break;case"replaygame":trace("## CNLA Gamification - Replay game");break;default:alreadyNotified=_checkIfAlreadyNotified(actionId);if(!alreadyNotified){if(typeof(trackSiteMilestones)=="function"){trackSiteMilestones({context:"backend",name:"gamification",ID:"notifyAction"},null)}gigya.gm.notifyAction({action:actionId,callback:function(data){_onNotifyActionSuccess(data,actionId)}})}break}}else{trace("## CNLA Gamification - User not logged - Queueing action: "+actionId);if(actionId.toLowerCase().indexOf("sys_")!==-1&&$.inArray(actionId,_sysActionsQueue)===-1){_sysActionsQueue.push(actionId);if(_store){_store.set("sysActionsQueue",_sysActionsQueue,5)}}else{if($.inArray(actionId,_actionsQueue)===-1){_actionsQueue.push(actionId)}}if(typeof(CNApplicationContainer)!="undefined"&&actionId.toLowerCase().indexOf("sys_")===-1){CNApplicationContainer.addMedallaUsuarioNoLogueado(actionId)}}},notifyGameComplete:function(){trace("## CNLA Gamification - notifyGameComplete not yet implemented")},getUserAchievements:function(challenges,fullInfo,callback){_getUserAchievements(challenges,fullInfo,callback)},getChallenges:function(challenges,callback){gigya.gm.getChallengeConfig({includeChallenges:challenges,callback:callback})},getCompletedGames:function(callback){trace("## CNLA Gamification - getCompletedGames not yet implemented");callback()},getTopUsers:function(totalCount,callback){if(typeof(totalCount)!="number"){totalCount=4}var callParams={countryCode:_loggedUserCountry!==null?_loggedUserCountry:_country,challengeId:"_default",totalCount:totalCount};if(_isLogged){callParams.UID=_loggedUserId}gigya.gm.getTopUsers({totalCount:totalCount,includeSelf:_isLogged,callback:function(data){if(data.users){var users=data.users;var ret=[];for(var i=0,len=users.length;i<len;i++){ret.push({id:users[i].UID,userName:users[i].name,rank:users[i].rank,image:users[i].photoURL})}ret=ret.sort(function(a,b){return a.rank-b.rank});callback(ret)}else{callback(null)}}})},getVersion:function(){return _version}};_country=CNConfig.country;var trace=function(str){if(typeof(console)!="undefined"){if(console){console.log(str)}}};trace("## CNLA Gamification - Version "+_version);$(document).on("storage.load",function(e,store){var _tempActionsQueue=store.get("sysActionsQueue");_store=store;if(_tempActionsQueue!==null){_sysActionsQueue=$.unique(_sysActionsQueue.concat(_tempActionsQueue))}store.set("sysActionsQueue",_sysActionsQueue,5)});$(document).on("gigya.load",function(e){var session=CNSessionController;_isLogged=session.isUserLoggedIn();if(_isLogged){_instance.notifyLogin(session)}});return _instance})();_swcNotifyAction=function(actionId){return CNLAGames.notifyAction(actionId)};_swcSetPoints=function(points){return CNLAGames.setPoints(points)};_swcGetVersion=function(){return CNLAGames.getVersion()}}else{if(typeof(console)!="undefined"){if(console){console.log("## CNLA Gamification - jQuery required")}}}var ChallengesController={GAME_LIST:"gameList",CHALLENGE_LIST:"challengeList",ACHIEVEMENT_LIST:"achievementList",ALL_ACHIEVEMENT_LIST:"allAchievementList",$document:null,list:{},loadCompleteList:{},offlineUserAchivementList:[],initialized:false,userInfo:null,isRunning:false,needsRerun:false,init:function(){if(this.initialized){return}this.$document=$(document);this.$document.on("gigya.load",$.proxy(this.refresh,this));this.initialized=true},refresh:function(){if(this.isRunning){this.needsRerun=true;return}this.isRunning=true;this.userInfo=CNSessionController.getUserInfo();CNLALibrary.getGameListWithChallenges($.proxy(this.onGetGameListWithChallengesCompleteHandler,this))},onGetGameListWithChallengesCompleteHandler:function(data){this.list[this.GAME_LIST]=data;this.dispatchLoad("challenges.gameList",this.GAME_LIST);CNLAGames.getChallenges("",$.proxy(this.onGetChallengesConfigCompleteHandler,this))},onGetChallengesConfigCompleteHandler:function(data){if(!("challenges" in data)){return}this.list[this.CHALLENGE_LIST]=data.challenges;this.dispatchLoad("challenges.challengeList",this.CHALLENGE_LIST);CNLAGames.getUserAchievements("",true,$.proxy(this.onGetChallengeStatusCompleteHandler,this))},onGetChallengeStatusCompleteHandler:function(data){var achievement,challenge,tmp,allAchievementList=[],achievementListLength,i;if(!data||!("achievements" in data)){tmp=[];if(!this.userInfo){achievementListLength=this.offlineUserAchivementList.length;for(i=0;i<achievementListLength;i++){tmp.push({challengeID:this.offlineUserAchivementList[i]})}}this.list[this.ACHIEVEMENT_LIST]=tmp}else{this.list[this.ACHIEVEMENT_LIST]=data.achievements}this.dispatchLoad("challenges.achievementList",this.ACHIEVEMENT_LIST);achievementListLength=this.list[this.ACHIEVEMENT_LIST].length;for(i=0;i<achievementListLength;i++){achievement=this.list[this.ACHIEVEMENT_LIST][i];if(this.userInfo){if(!this.hasAchievement(achievement.challengeID)){continue}}challenge=this.getChallengeByChallengeId(achievement.challengeID);if(!(challenge&&challenge.challengeID!="_default"&&challenge.levels&&challenge.levels[0].badgeURL)){continue}if(achievement.challengeID.toUpperCase().indexOf("LDR_")==0){continue}if(achievement.challengeID.indexOf("Sys_")==0){tmp=this.getUngroupedAchievements(challenge,achievement.level);allAchievementList=allAchievementList.concat(tmp)}else{allAchievementList.push(challenge)}}this.list[this.ALL_ACHIEVEMENT_LIST]=allAchievementList;this.dispatchLoad("challenges.allAchievementList",this.ALL_ACHIEVEMENT_LIST);this.isRunning=false;if(this.needsRerun){this.needsRerun=false;this.refresh()}},hasAchievement:function(challengeID){var achievement,leaderBoards;if(!this.userInfo){return false}achievement=this.getAchievementByChallengeId(challengeID);if(achievement&&challengeID.indexOf("Sys_")==0){return true}if(!achievement||!achievement.badgeURL){return false}leaderBoards=this.getLeaderBoardsIds();if($.inArray(challengeID,leaderBoards)!=-1){return false}return true},getAchievementByChallengeId:function(challengeID){var achievementListLength=this.list[this.ACHIEVEMENT_LIST].length,i;for(i=0;i<achievementListLength;i++){if(this.list[this.ACHIEVEMENT_LIST][i].challengeID==challengeID){return this.list[this.ACHIEVEMENT_LIST][i]}}return null},getLeaderBoardsIds:function(){var result=[],gameList=this.list[this.GAME_LIST],gameListLength=gameList.length,i,current;for(i=0;i<gameListLength;i++){current=gameList[i].leaderboard;if(current===null){current=["_default"]}result.push(current[0])}return result},getChallengeByChallengeId:function(challengeID){var challengeListLength=this.list[this.CHALLENGE_LIST].length,i;for(i=0;i<challengeListLength;i++){if(this.list[this.CHALLENGE_LIST][i].challengeID==challengeID){return this.list[this.CHALLENGE_LIST][i]}}return null},getUngroupedAchievements:function(challenge,maxLevel){var list=[],levelData,dummyAchievement,challengeLevelsLength=challenge.levels.length,i;for(i=0;i<challengeLevelsLength;i++){levelData=challenge.levels[i];if(levelData.level>maxLevel){continue}dummyAchievement={};dummyAchievement.challengeID=challenge.challengeID;dummyAchievement.name=challenge.name;dummyAchievement.description=challenge.description;dummyAchievement.badgeURL=this.getBadgeURL(challenge.badgeURL,levelData.level);dummyAchievement.levels=[];dummyAchievement.levels.push(challenge.levels[i]);list.push(dummyAchievement)}return list},getBadgeURL:function(url,level){if(!url){return url}return url.replace(/_(\d+)\.(png|jpg|jpeg)$/gi,"_"+level+".$2")},getList:function(list){return this.list[list]},addMedallaUsuarioNoLogueado:function(actionId){this.offlineUserAchivementList.push(actionId);this.onGetChallengeStatusCompleteHandler()},dispatchLoad:function(eventType,listType){this.$document.trigger(eventType,[this.list[listType]])}};