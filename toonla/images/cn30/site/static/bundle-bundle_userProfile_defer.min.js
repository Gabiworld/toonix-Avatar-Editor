var UserProfileController={$userProfile:null,$user:null,$userName:null,$userCredits:null,$userCreditsPopupBtn:null,$userCreditsSMS:null,$level:null,$levelBar:null,$levelBarProgress:null,$levelList:null,$levelInfoBtn:null,$infoLevels:null,$infoLevelsCloseBtn:null,$untilNextLevel:null,$achievements:null,$achievementsList:null,$achievementsCount:null,userInfo:null,levels:[],init:function(){this.$userProfile=$("#userProfile");this.$user=this.$userProfile.find(".user");this.$userAvatar=this.$user.find(".avatar");this.$userAvatarName=this.$userAvatar.find(".nickname");this.$userAvatarCredits=this.$userAvatar.find(".credits-value");this.$userCreditsPopupBtn=this.$user.find(".creditsPopup");this.$userCreditsSMS=this.$user.find(".nickBlock");this.$level=this.$userProfile.find(".nivel");this.$levelBar=this.$level.find("#barraNivel");this.$levelBarProgress=this.$levelBar.find(".progressBar");this.$levelList=this.$levelBar.find(".listNiveles");this.$levelInfoBtn=this.$levelBar.find(".btn-info");this.$infoLevels=this.$level.find("#infoNiveles");this.$infoLevelsCloseBtn=this.$infoLevels.find(".btn-cerrar");this.$untilNextLevel=this.$level.find(".untilNextLevel");this.$achievements=this.$userProfile.find(".medallas");this.$achievementsCount=this.$achievements.find(".nro");this.$achievementsList=this.$achievements.find(".listMedals");this.$userCreditsPopupBtn.click($.proxy(this.onCreditsPopupClickHandler,this));this.$levelInfoBtn.click($.proxy(this.onBarraNivelBtnInfoClickHandler,this));this.$infoLevelsCloseBtn.click($.proxy(this.onInfoNivelesBtnCerrarClickHandler,this));$(document).on("session.status challenges.challengeList challenges.allAchievementList credits.update",$.proxy(this.onEvent,this))},initUser:function(){this.$userAvatarName.html(this.userInfo.userName);this.$userCreditsSMS.html("CN "+this.userInfo.userName);this.showCredits(this.userInfo.credits);this.$userAvatar.removeClass("invisible")},initLevelBar:function(){var defaultChallenge=ChallengesController.getChallengeByChallengeId("_default").levels,levels=this.levels,i=0,sub=-1,levelsLength=defaultChallenge.length;for(;i<levelsLength;i++){if((i%5)===0){sub++;levels[sub]=[]}levels[sub].push(defaultChallenge[i])}},showCredits:function(credits){credits=CNHelpers.creditsFiller(credits);this.$userAvatarCredits.text(credits)},showLevelBar:function(){var levelMeterPos=[12,27,42,57,72,87,102,117,132,144,157,172,187,202,215,229,244,259,274,287,300,315,330,345,362],defaultAchievement=ChallengesController.getAchievementByChallengeId("_default"),defaultAchievementLevel=defaultAchievement.level-1,levels=this.levels,levelsLength=levels.length,levelsHTML="",levelID,sublevelID,sublevelLength,sublevelClass;this.$levelBarProgress.css({height:levelMeterPos[defaultAchievementLevel]+"px"});levelID=Math.floor(defaultAchievementLevel/5);sublevelID=defaultAchievementLevel%5;while(levelsLength--){levelsHTML+="<div class='level'>";if(levelsLength===levelID){sublevelLength=levels[levelsLength].length;levelsHTML+="<ul class='names'>";while(sublevelLength--){sublevelClass=sublevelLength===sublevelID?"txtDestacar":"txtSmall";levelsHTML+="<li class='"+sublevelClass+"'>"+levels[levelsLength][sublevelLength].title+"</li>"}levelsHTML+="</ul>"}else{levelsHTML+=levels[levelsLength][1].title}levelsHTML+="</div>"}this.$levelList.html(levelsHTML);this.$untilNextLevel.html(defaultAchievement.achievementsToNextLevel);this.$level.removeClass("loading");this.$levelBar.removeClass("invisible")},showAchievements:function(allAchievementList){var html="",i,$imageList;for(i=0;i<15;i++){if(typeof allAchievementList[i]=="undefined"){html+='<div class="item"></div>';continue}html+='<div class="item"><img src="'+allAchievementList[i].levels[0].badgeURL+'" alt="'+allAchievementList[i].name+'" width="136" height="134" /></div>'}html+='<div class="cb"></div>';this.$achievementsCount.html(allAchievementList.length);this.$achievementsList.html(html);this.$achievementsList.removeClass("loading");$imageList=this.$achievementsList.find("img");$imageList.each($.proxy(this.eachAchievementImageHandler,this,$imageList))},eachAchievementImageHandler:function($imageList,e){var $image=$imageList.eq(e),imageSrc=$image.attr("src");$image.load($.proxy(this.onAchievementImageLoadHandler,this)).attr("src",imageSrc)},onAchievementImageLoadHandler:function(e){$(e.currentTarget).fadeIn()},onCreditsPopupClickHandler:function(){LightboxCreditsPopupController.open()},onBarraNivelBtnInfoClickHandler:function(){this.$levelBar.stop(true,true).hide();this.$infoLevels.stop(true,true).fadeIn()},onInfoNivelesBtnCerrarClickHandler:function(){this.$infoLevels.stop(true,true).hide();this.$levelBar.stop(true,true).fadeIn()},onEvent:function(e,extraParams){if(e.type==="session"){this.onSessionStatus(e,extraParams)}else{if(e.type==="challenges"&&e.namespace==="challengeList"){this.onChallengeList(e,extraParams)}else{if(e.type==="challenges"&&e.namespace==="allAchievementList"){this.onAllAchievementList(e,extraParams)}else{if(e.type==="credits"){this.onCreditsUpdate(e,extraParams)}}}}},onSessionStatus:function(e,session){if(session.isUserLoggedIn()){this.userInfo=session.getUserInfo();this.initUser()}else{window.location=CNConfig.domain}},onChallengeList:function(e,challengeList){this.initLevelBar()},onAllAchievementList:function(e,allAchievementList){this.showLevelBar();this.showAchievements(allAchievementList)},onCreditsUpdate:function(e,credits){this.showCredits(credits)}};UserProfileController.init();AvatarDisplayController.init("userProfileAvatarSwf","126","170");new LightboxRecuperaDatosController("#lightboxUsuarioInexistente").init();new LightboxRecuperaDatosController("#lightboxRecuperaDatos").init();